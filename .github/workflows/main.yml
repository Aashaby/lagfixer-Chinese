name: Build LagFixer

on:
  push:
    branches: [ "main" ]
    tags: [ "*" ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-24.04

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Maven local (Spigot 1.16.5)
        id: cache-spigot
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository/org/spigotmc
            ~/.m2/repository/net/minecraft
          key: m2-${{ runner.os }}-spigot-1.16.5

      - name: Set up JDK 11 (for BuildTools 1.16.5)
        if: steps.cache-spigot.outputs.cache-hit != 'true'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      - name: Install Spigot 1.16.5 into Maven local (BuildTools)
        if: steps.cache-spigot.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p buildtools
          cd buildtools
          curl -fsSL -o BuildTools.jar https://hub.spigotmc.org/jenkins/job/BuildTools/lastSuccessfulBuild/artifact/target/BuildTools.jar
          java -jar BuildTools.jar --rev 1.16.5 --compile SPIGOT

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Set up JDK 21 (for Gradle toolchains)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build and test with Gradle
        run: ./gradlew clean build --no-daemon --stacktrace --build-cache

      - name: List build outputs
        if: success()
        shell: bash
        run: |
          ls -la build/libs || true

      - name: Resolve release tag from Gradle version
        id: release_tag
        if: success() && startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          VERSION=$(./gradlew -q properties --no-daemon | awk -F': ' '/^version: /{print $2; exit}')
          if [ -z "$VERSION" ]; then
            echo "Failed to resolve Gradle version" >&2
            exit 1
          fi

          REF_TAG="${{ github.ref_name }}"
          if [ "$REF_TAG" != "$VERSION" ] && [ "$REF_TAG" != "v$VERSION" ]; then
            echo "Tag '$REF_TAG' does not match Gradle version '$VERSION'" >&2
            exit 1
          fi

          echo "value=$REF_TAG" >> "$GITHUB_OUTPUT"

      - name: Verify LagFixer.jar exists
        if: success() && startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          test -f build/libs/LagFixer.jar

      - name: Create GitHub Release (tag)
        if: success() && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.value }}
          files: build/libs/LagFixer.jar

      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: LagFixer
          path: |
            build/libs/*.jar
            **/build/libs/*.jar
